<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Slot Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      background:#0d1522;
      font-family:Arial, sans-serif;
      color:white;
      text-align:center;
      margin:0;
      padding:20px;
    }
    #reels {
      display:flex;
      justify-content:center;
      gap:10px;
      margin-top:20px;
    }
    .reel {
      width:80px;
      height:80px;
      background:#111a2d;
      border:2px solid #222f44;
      border-radius:8px;
      font-size:40px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #status {
      margin-top:20px;
      font-size:18px;
      color:#ffb86b;
    }
    button {
      margin-top:25px;
      padding:10px 20px;
      border:0;
      background:#ffb86b;
      color:black;
      border-radius:6px;
      font-size:16px;
      font-weight:bold;
    }
    #balanceBox {
      margin-top:15px;
      font-size:20px;
      color:#9aa4b2;
    }
  </style>
</head>
<body>

  <h2>ðŸŽ° Slot Machine</h2>

  <div id="balanceBox">Balance: â€”</div>

  <div id="reels">
    <div class="reel" id="r1">?</div>
    <div class="reel" id="r2">?</div>
    <div class="reel" id="r3">?</div>
  </div>

  <button onclick="startSpin()">SPIN 50</button>

  <div id="status"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDXGN7xdSPFW2Bj_W0WHauUabpcWQKtYKM",
      authDomain: "asiatiger-c41d3.firebaseapp.com",
      projectId: "asiatiger-c41d3",
      storageBucket: "asiatiger-c41d3.firebasestorage.app",
      messagingSenderId: "595368304934",
      appId: "1:595368304934:web:ae946ffe0e28e8758261e7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentTgid = null;
    let stopSub = null;

    function getTgidFromURL() {
      const p = new URLSearchParams(window.location.search);
      if (p.has("tgid")) return p.get("tgid");
      return null;
    }

    async function detectTGID(user) {
      if (!user) return null;
      try {
        const token = await user.getIdTokenResult();
        if (token?.claims?.tgid) return token.claims.tgid;
      } catch(e){}
      if (user.email) return user.email.split("@")[0];
      return user.uid;
    }

    function watchBalance(tgid) {
      if (stopSub) stopSub();
      stopSub = db.collection("users").doc(String(tgid))
        .onSnapshot(doc => {
          const d = doc.data() || {};
          document.getElementById("balanceBox").textContent =
            "Balance: " + (d.coin_balance ?? 0);
        });
    }

    auth.onAuthStateChanged(async user => {
      const urlTgid = getTgidFromURL();
      const derived = await detectTGID(user);
      currentTgid = urlTgid || derived;

      if (!currentTgid) {
        document.getElementById("balanceBox").textContent = "Balance: Login required";
        return;
      }
      watchBalance(currentTgid);
    });

    async function apiSpin(game, bet) {
      const user = auth.currentUser;
      const headers = { "Content-Type": "application/json" };
      if (user) {
        const idToken = await user.getIdToken();
        headers["Authorization"] = "Bearer " + idToken;
      }
      const res = await fetch("/api/spin", {
        method: "POST",
        headers,
        body: JSON.stringify({
          tgid: currentTgid,
          game,
          bet,
          clientSeed: "slot_web"
        })
      });
      if (!res.ok) throw new Error("Spin API error " + res.status);
      return await res.json();
    }

    async function startSpin() {
      if (!currentTgid) {
        alert("Login first!");
        return;
      }

      document.getElementById("status").textContent = "Spinningâ€¦";

      try {
        const result = await apiSpin("slot", 50);
        const arr = result?.reels || ["â“","â“","â“"];
        document.getElementById("r1").textContent = arr[0];
        document.getElementById("r2").textContent = arr[1];
        document.getElementById("r3").textContent = arr[2];

        if (result?.win > 0) {
          document.getElementById("status").textContent =
            "YOU WIN +"+result.win;
        } else {
          document.getElementById("status").textContent = "No win";
        }
      } catch (e) {
        console.error(e);
        document.getElementById("status").textContent = "Error: " + e.message;
      }
    }
  </script>
</body>
</html>
