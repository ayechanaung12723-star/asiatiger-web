<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AsiaTiger — Home</title>
  <meta name="description" content="AsiaTiger web games" />
  <link rel="icon" href="logo.png" />
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#ffb86b;--muted:#9aa4b2;color-scheme:dark}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,#071021 0%,#071827 100%);color:#e6eef6}
    .container{max-width:1100px;margin:36px auto;padding:24px}
    header{display:flex;align-items:center;gap:16px}
    header img{width:64px;height:64px;border-radius:8px;object-fit:cover}
    header h1{font-size:1.6rem;margin:0}
    nav{margin-top:12px;display:flex;gap:12px;flex-wrap:wrap}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--accent);text-decoration:none;font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:20px}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .card h3{margin:0 0 8px 0;font-size:1.05rem}
    .card p{margin:0;color:var(--muted);font-size:0.95rem}
    footer{margin-top:28px;color:var(--muted);font-size:0.9rem;text-align:center}
    .games-list{display:flex;flex-direction:column;gap:8px}
    .games-list a{display:inline-block;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);color:#dfe9f3;text-decoration:none}
    .top-actions{margin-left:auto;display:flex;gap:8px}
    .balance{background:#071827;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
    .note{color:var(--muted);font-size:13px}
    @media (max-width:600px){header{flex-direction:column;align-items:flex-start}.top-actions{margin-left:0}}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="logo.png" alt="AsiaTiger logo" />
      <div>
        <h1>AsiaTiger</h1>
        <div class="note">Play web games • Fast deploy • Built with JavaScript</div>
      </div>
      <div class="top-actions">
        <a id="loginLink" class="btn" href="login.html">Login</a>
        <button id="logoutBtn" class="btn" style="display:none">Logout</button>
      </div>
    </header>

    <nav>
      <a class="btn" href="games.html">All Games</a>
      <a class="btn" href="stats.html">Stats</a>
      <a class="btn" href="wallet.html">Wallet</a>
      <a class="btn" href="logs.html">Logs</a>
      <a class="btn" href="https://asiatiger-web.vercel.app" target="_blank">Live Site</a>
    </nav>

    <main>
      <section style="margin-top:20px">
        <div class="card">
          <h3>Featured Games</h3>
          <p>Quick access to a few popular games. Click to open and play in your browser.</p>
          <div class="games-list" style="margin-top:12px">
            <a href="games/five_slot_games.html" onclick="return openGame('games/five_slot_games.html')">Slot</a>
            <a href="games/fishing.html" onclick="return openGame('games/fishing.html')">Fishing</a>
            <a href="games/candy.js" onclick="return openGame('games/candy.js')">Candy (JS)</a>
          </div>
        </div>
      </section>

      <section class="grid" aria-label="site sections">
        <div class="card">
          <h3>About</h3>
          <p>AsiaTiger is a lightweight web game collection. This repo contains HTML, JS and assets for client side games.</p>
        </div>

        <div class="card">
          <h3>Balance</h3>
          <div class="balance">
            <div class="small">Balance</div>
            <div id="balanceDisplay" style="font-size:20px;font-weight:bold">—</div>
            <div id="vipDisplay" style="font-size:12px;color:var(--muted);margin-top:6px">VIP: —</div>
            <div id="tgidDisplay" class="small" style="margin-top:8px">Not logged in</div>
          </div>
        </div>

        <div class="card">
          <h3>Resources</h3>
          <p>Sounds and images are stored under the sounds and games folders. Use compressed assets for faster load.</p>
        </div>

        <div class="card">
          <h3>Contact</h3>
          <p class="note">For issues or updates, use the repository on GitHub or contact admin via Telegram.</p>
        </div>
      </section>
    </main>

    <footer>
      © <span id="year"></span> AsiaTiger — All rights reserved
    </footer>
  </div>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ====== YOUR FIREBASE CONFIG (inserted as requested) ======
    const firebaseConfig = {
      apiKey: "AIzaSyDXGN7xdSPFW2Bj_W0WHauUabpcWQKtYKM",
      authDomain: "asiatiger-c41d3.firebaseapp.com",
      projectId: "asiatiger-c41d3",
      storageBucket: "asiatiger-c41d3.firebasestorage.app",
      messagingSenderId: "595368304934",
      appId: "1:595368304934:web:ae946ffe0e28e8758261e7"
    };
    // ==========================================================

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // UI elements
    document.getElementById('year').textContent = new Date().getFullYear();
    const balanceEl = document.getElementById('balanceDisplay');
    const vipEl = document.getElementById('vipDisplay');
    const tgidEl = document.getElementById('tgidDisplay');
    const loginLink = document.getElementById('loginLink');
    const logoutBtn = document.getElementById('logoutBtn');

    // global current tgid
    window.currentTgid = null;
    let unsubscribeBalance = null;

    function setLoggedOutUI() {
      balanceEl.textContent = '—';
      vipEl.textContent = 'VIP: —';
      tgidEl.textContent = 'Not logged in';
      loginLink.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
    }
    function setLoggedInUI(tgid) {
      loginLink.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
      tgidEl.textContent = 'TGID: ' + tgid;
    }

    // derive tgid from token claims or email prefix or uid
    async function deriveTgid(user) {
      try {
        const idTokenResult = await user.getIdTokenResult(true);
        const claimTgid = idTokenResult?.claims?.tgid;
        if (claimTgid) return String(claimTgid);
      } catch (e) {
        console.warn('getIdTokenResult failed', e);
      }
      if (user.email) return user.email.split('@')[0];
      return user.uid;
    }

    // subscribe to user's Firestore doc for realtime balance
    function subscribeBalance(tgid) {
      if (unsubscribeBalance) { unsubscribeBalance(); unsubscribeBalance = null; }
      const docRef = db.collection('users').doc(String(tgid));
      unsubscribeBalance = docRef.onSnapshot(doc => {
        if (!doc.exists) {
          balanceEl.textContent = '0';
          vipEl.textContent = 'VIP: —';
          return;
        }
        const data = doc.data();
        balanceEl.textContent = String(data.coin_balance ?? 0);
        vipEl.textContent = 'VIP: ' + (data.vip_tier ?? '—');
      }, err => {
        console.error('balance listener error', err);
      });
    }

    // auth state listener
    auth.onAuthStateChanged(async user => {
      // cleanup
      if (unsubscribeBalance) { unsubscribeBalance(); unsubscribeBalance = null; }
      window.currentTgid = null;

      if (!user) {
        setLoggedOutUI();
        return;
      }

      // derive tgid and subscribe
      const tgid = await deriveTgid(user);
      window.currentTgid = String(tgid);
      setLoggedInUI(window.currentTgid);
      subscribeBalance(window.currentTgid);
    });

    // logout button
    logoutBtn.addEventListener('click', async () => {
      try {
        await auth.signOut();
      } catch (e) {
        console.error('Sign out failed', e);
        alert('Logout failed');
      }
    });

    // Minimal API helper used by game pages
    window.apiSpin = async function(payload) {
      try {
        const res = await fetch('/api/spin', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text}`);
        }
        return await res.json();
      } catch (err) {
        console.error('apiSpin error', err);
        throw err;
      }
    };

    // doSpin used by game pages
    window.doSpin = async function(game, bet) {
      if (!window.currentTgid) {
        alert('You need to login first');
        return null;
      }
      try {
        const payload = { tgid: window.currentTgid, game, bet, clientSeed: 'web' };
        const result = await window.apiSpin(payload);
        return result;
      } catch (e) {
        alert('Spin failed: ' + (e.message || 'server error'));
        return null;
      }
    };

    // open game helper
    window.openGame = function(url) {
      window.location.href = url;
      return false;
    };

    // debug helper (optional)
    window.__debug = {
      currentTgid: () => window.currentTgid,
      signInTest: async () => {
        try {
          const cred = await auth.signInAnonymously();
          console.log('anon signed in', cred);
        } catch (e) { console.error(e); }
      }
    };
  </script>
</body>
</html>
