<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AsiaTiger — Home</title>
  <link rel="icon" href="logo.png" />
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#ffb86b;--muted:#9aa4b2;color-scheme:dark}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,#071021 0%,#071827 100%);color:#e6eef6}
    .container{max-width:1100px;margin:36px auto;padding:24px}
    header{display:flex;align-items:center;gap:16px}
    header img{width:64px;height:64px;border-radius:8px;object-fit:cover}
    header h1{font-size:1.6rem;margin:0}
    nav{margin-top:12px;display:flex;gap:12px;flex-wrap:wrap}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--accent);text-decoration:none;font-weight:600}
    .games-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .balance{background:#071827;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="logo.png" alt="AsiaTiger logo" />
      <div>
        <h1>AsiaTiger</h1>
        <div style="color:var(--muted)">Play web games • Fast deploy • Built with JavaScript</div>
      </div>
      <div style="margin-left:auto">
        <a id="loginLink" class="btn" href="login.html">Login</a>
        <button id="logoutBtn" class="btn" style="display:none">Logout</button>
      </div>
    </header>

    <nav>
      <a class="btn" href="games.html">All Games</a>
      <a class="btn" href="stats.html">Stats</a>
      <a class="btn" href="wallet.html">Wallet</a>
      <a class="btn" href="logs.html">Logs</a>
    </nav>

    <main>
      <section style="margin-top:20px">
        <div style="background:var(--card);padding:14px;border-radius:10px">
          <h3>Featured Games</h3>
          <p style="color:var(--muted)">Quick access to a few popular games. Click to open and play in your browser.</p>
          <div class="games-list">
            <a href="games/five_slot_games.html" onclick="return openGame('games/five_slot_games.html')">Slot</a>
            <a href="games/fishing.html" onclick="return openGame('games/fishing.html')">Fishing</a>
            <a href="games/candy.js" onclick="return openGame('games/candy.js')">Candy (JS)</a>
          </div>
        </div>
      </section>

      <section style="display:grid;grid-template-columns:1fr 320px;gap:16px;margin-top:20px">
        <div style="background:var(--card);padding:14px;border-radius:10px">
          <h3>About</h3>
          <p style="color:var(--muted)">AsiaTiger is a lightweight web game collection. This repo contains HTML, JS and assets for client side games.</p>
        </div>

        <div style="background:var(--card);padding:14px;border-radius:10px">
          <h3>Balance</h3>
          <div class="balance">
            <div style="font-size:13px;color:var(--muted)">Balance</div>
            <div id="balanceDisplay" style="font-size:20px;font-weight:bold">—</div>
            <div id="vipDisplay" style="font-size:12px;color:var(--muted);margin-top:6px">VIP: —</div>
            <div id="tgidDisplay" style="font-size:13px;color:var(--muted);margin-top:8px">Not logged in</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ====== Replace with your Firebase config ======
    const firebaseConfig = {
      apiKey: "AIzaSyDXGN7xdSPFW2Bj_W0WHauUabpcWQKtYKM",
      authDomain: "asiatiger-c41d3.firebaseapp.com",
      projectId: "asiatiger-c41d3",
      storageBucket: "asiatiger-c41d3.firebasestorage.app",
      messagingSenderId: "595368304934",
      appId: "1:595368304934:web:ae946ffe0e28e8758261e7"
    };
    // ==============================================

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // UI refs
    document.getElementById('tgidDisplay').textContent = 'Checking...';
    const balanceEl = document.getElementById('balanceDisplay');
    const vipEl = document.getElementById('vipDisplay');
    const loginLink = document.getElementById('loginLink');
    const logoutBtn = document.getElementById('logoutBtn');

    window.currentTgid = null;
    let unsubscribeBalance = null;

    function setLoggedOutUI() {
      balanceEl.textContent = '—';
      vipEl.textContent = 'VIP: —';
      document.getElementById('tgidDisplay').textContent = 'Not logged in';
      loginLink.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
    }
    function setLoggedInUI(tgid) {
      loginLink.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
      document.getElementById('tgidDisplay').textContent = 'TGID: ' + tgid;
    }

    async function deriveTgid(user) {
      try {
        const idTokenResult = await user.getIdTokenResult(true);
        if (idTokenResult?.claims?.tgid) return String(idTokenResult.claims.tgid);
      } catch (e) { console.warn(e); }
      if (user.email) return user.email.split('@')[0];
      return user.uid;
    }

    function subscribeBalance(tgid) {
      if (unsubscribeBalance) { unsubscribeBalance(); unsubscribeBalance = null; }
      const ref = db.collection('users').doc(String(tgid));
      unsubscribeBalance = ref.onSnapshot(doc => {
        if (!doc.exists) {
          balanceEl.textContent = '0';
          vipEl.textContent = 'VIP: —';
          return;
        }
        const d = doc.data();
        balanceEl.textContent = String(d.coin_balance ?? 0);
        vipEl.textContent = 'VIP: ' + (d.vip_tier ?? '—');
      }, err => {
        console.error('balance listener error', err);
      });
    }

    auth.onAuthStateChanged(async user => {
      if (unsubscribeBalance) { unsubscribeBalance(); unsubscribeBalance = null; }
      window.currentTgid = null;
      if (!user) { setLoggedOutUI(); return; }
      const tgid = await deriveTgid(user);
      window.currentTgid = String(tgid);
      setLoggedInUI(window.currentTgid);
      subscribeBalance(window.currentTgid);
    });

    logoutBtn.addEventListener('click', async () => {
      try { await auth.signOut(); } catch(e){ console.error(e); alert('Logout failed'); }
    });

    // apiSpin: sends ID token in Authorization header (server must verify)
    window.apiSpin = async function(payload) {
      try {
        const user = firebase.auth().currentUser;
        const headers = {'Content-Type':'application/json'};
        if (user) {
          const idToken = await user.getIdToken();
          headers['Authorization'] = 'Bearer ' + idToken;
        }
        const res = await fetch('/api/spin', {
          method: 'POST',
          headers,
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text}`);
        }
        return await res.json();
      } catch (err) {
        console.error('apiSpin error', err);
        throw err;
      }
    };

    // doSpin used by game pages
    window.doSpin = async function(game, bet) {
      if (!window.currentTgid) {
        alert('You need to login first');
        return null;
      }
      try {
        const payload = { tgid: window.currentTgid, game, bet, clientSeed: 'web' };
        const result = await window.apiSpin(payload);
        return result;
      } catch (e) {
        console.error('doSpin error', e);
        alert('Spin failed: ' + (e.message || 'server error'));
        return null;
      }
    };

    // openGame: append tgid if available
    window.openGame = function(url) {
      try {
        const tgid = window.currentTgid;
        if (tgid) {
          const sep = url.includes('?') ? '&' : '?';
          window.location.href = url + sep + 'tgid=' + encodeURIComponent(tgid);
          return false;
        }
      } catch(e){}
      window.location.href = url;
      return false;
    };

    // debug helpers
    window.__debug = {
      currentTgid: () => window.currentTgid
    };
  </script>
</body>
</html>
